<script>
  (function() {
    var metodosDePagamentoSection = document.querySelector('.section-payment .section-body');
    var metodosDePagamentoDiv = [];
    var pagamentoEscolhido = '';
    //Populando array com as formas de pagamento possíveis
    if (metodosDePagamentoSection !== null) {
      metodosDePagamentoSection.childNodes.forEach(function(metodoDePagamento) {
        if (metodoDePagamento.nodeName === 'DIV') metodosDePagamentoDiv.push(metodoDePagamento);
      });
    }
    //Adicionando evento ao radioButton e capturando a escolha do usuário
    if (metodosDePagamentoDiv !== null) {
      metodosDePagamentoDiv.forEach(function(div) {
        var radioButton = div.childNodes[0].childNodes[0].childNodes[0];
        var radioText = div.childNodes[0].childNodes[0].childNodes[2].innerText
      
        radioButton.addEventListener('change', function(event) {
          pagamentoEscolhido = radioText;
          console.log('Forma de pagamento: ' + pagamentoEscolhido);
        });
      });
    }
    //Preparando dados para popular o dataLayer
    var produtosTable = document.querySelector('#content > div > div > div.right > div.checkout-section.cart-section > div.section-body > div > table > tbody');
    var produtos = [];
    var produtosObj = [];
    //Populando array com os produtos escolhidos
    if (produtosTable !== null) {
      produtosTable.childNodes.forEach(function(produto) {
        if (produto.nodeName === 'TR') produtos.push(produto);
      });
    }
    //Populando array com os produtos escolhidos em forma de objeto
    if(produtos !== null) {
      produtos.forEach(function(produto) {
      var nomeDoProduto = produto.childNodes[2].innerText;
      var modeloDoProduto = produto.childNodes[4].innerText;
      var quantidadeProduto = produto.childNodes[6].childNodes[0].childNodes[0].childNodes[0].value
      var precoDoProduto = produto.childNodes[8].innerText;
      var totalDoProduto = produto.childNodes[10].innerText;
      
      produtosObj.push({
          'produtcName': nomeDoProduto,
          'produtcModel': modeloDoProduto,
          'produtcQuantity': quantidadeProduto,
          'produtcPrice': precoDoProduto,
          'produtcTotal': totalDoProduto
        });
      });
    }
    //Capturando informações do pagamento
    var labels = document.querySelectorAll('div.checkout-section.cart-section > div.section-body > table > tfoot > tr > td > strong');
    var desconto = '';
    var metodoFrete = '';
    var valorFrete = '';
    var subTotal = '';
    var total = '';    
    
    if (labels !== null) {
      labels.forEach(function(label) {
        if (label.textContent.toLowerCase().indexOf('desconto') !== -1) desconto = label.parentElement.parentElement.childNodes[2].textContent;
        
        if (label.textContent.toLowerCase().indexOf('dias') !== -1) {
          metodoFrete = label.textContent;
          valorFrete = label.parentElement.parentElement.childNodes[2].textContent;
        }
    
        if (label.textContent.toLowerCase().indexOf('sub-') !== -1) subTotal = label.parentElement.parentElement.childNodes[2].textContent;
    
        if (label.textContent.toLowerCase().indexOf('total') !== -1) total = label.parentElement.parentElement.childNodes[2].textContent;
      });
    }
    
    var botao = document.querySelector("#quick-checkout-button-confirm");
    
    botao.addEventListener('click', function() {
      //Populando dataLayer com os dados capturados da página do Checkout
      dataLayer.push({
        'event': 'purchase',
        'products': produtosObj,
        'paymentMethod': pagamentoEscolhido,
        'discount': desconto,
        'shippingMethod': metodoFrete,
        'shippingPrice': valorFrete,
        'subTotal': subTotal,
        'total': total
      });  
    })  
  })();
</script>
